# Cache Yamero 開発者向けテスト手順

## フォント・画像キャッシュ無効化の動作確認

### 前提条件
- プラグインが有効化されている
- 管理画面で「Cache Yamero を有効にする」がON
- 管理者権限でテスト実行

### テスト手順

#### 1. フォントの動作確認
**設定**: 管理画面で「フォント」チェックボックスをON

**確認方法**:
1. ブラウザの開発者ツール → Network タブを開く
2. キャッシュクリア後、サイトをリロード
3. フィルターで「Font」を選択
4. woff2/woff/ttf/otf/eot ファイルのURLに `?cache-yamero=YYYYMMDDHHMMSS` が付いていることを確認

**期待結果**: フォントファイルにキャッシュパラメータが付与される

#### 2. 画像の動作確認
**設定**: 管理画面で「画像」チェックボックスをON

**確認方法**:
1. ブラウザの開発者ツール → Network タブを開く
2. キャッシュクリア後、サイトをリロード
3. フィルターで「Img」を選択
4. 以下の画像URLに `?cache-yamero=YYYYMMDDHHMMSS` が付いていることを確認:
   - 投稿本文内の画像
   - アイキャッチ画像
   - srcset 内の各URL
   - lazy loading の data-src 属性

**期待結果**: 同一オリジンの画像ファイルにキャッシュパラメータが付与される

#### 3. 除外動作の確認
**設定**: 各チェックボックスをOFFに変更

**確認方法**:
1. フォントのチェックを外して保存 → フォントファイルにパラメータが付かない
2. 画像のチェックを外して保存 → 画像ファイルにパラメータが付かない
3. CSS/JSのチェックを外して保存 → CSS/JSファイルにパラメータが付かない

**期待結果**: OFFにしたリソース種別にはキャッシュパラメータが付与されない

#### 4. 同一時刻値の確認
**確認方法**:
1. 同一ページ内のすべてのリソース（CSS/JS/画像/フォント）の `cache-yamero` パラメータ値が同一であることを確認

**期待結果**: 同一リクエスト内では全リソースが同一タイムスタンプを持つ

#### 5. 除外条件の確認
**確認方法**:
1. 外部オリジンの画像/フォントにパラメータが付かないことを確認
2. data:// や blob:// URLにパラメータが付かないことを確認

**期待結果**: 除外対象にはキャッシュパラメータが付与されない

### 主要修正箇所の説明

#### フォント二重除外バグ修正
- **問題**: `resource_type='fonts'` で除外後、拡張子判定で再除外
- **修正**: 行419-421の二重チェック削除

#### 画像系ラッパー修正
- **問題**: `of_add_cache_param_to_attachment_url()` 等で `resource_type` 未指定
- **修正**: 全画像系ラッパーで `'images'` パラメータ追加

#### 新規フック追加
- `wp_get_attachment_image_url`: 画像URL取得
- `wp_calculate_image_srcset`: srcset配列の各URL処理

### 対象リソース
- **CSS**: `wp_enqueue_style`で読み込まれるCSSファイル
- **JavaScript**: `wp_enqueue_script`で読み込まれるJSファイル
- **画像**: WordPressのメディア機能、コンテンツ内画像、アイキャッチ画像

### 既知の制限
- CSSファイル内の `url(...)` で参照される背景画像は対象外
- テーマ直書きの `<img>` タグは対象外

### 変更履歴 (v1.1.0)
- **2024-09-18 追加**: リソース種別ターゲティング機能
  - CSS、JavaScript、画像を個別に制御可能
  - 管理画面での各リソース種別有効/無効設定
  - 画像処理の強化（srcset、lazy loading属性対応）
- **2024-09-18 削除**: フォント機能を完全削除（技術的制約のため）
  - 管理画面からフォントチェックボックスを削除
  - フォント関連の設定オプション削除
  - フォント向けフィルター処理削除